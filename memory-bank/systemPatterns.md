# ScalarDB ベンチマークツール: システムパターン

## システムアーキテクチャ

ScalarDBベンチマークツールは、[Kelpie](https://github.com/scalar-labs/kelpie)というテストフレームワークを基盤として構築されています。全体的なアーキテクチャは以下の構成要素から成り立っています：

```
┌─────────────────────────────────────────────┐
│               ベンチマーク定義              │
│  ┌─────────┐  ┌─────────┐  ┌─────────────┐  │
│  │ プリプロ │  │プロセッサ│  │ポストプロセッサ│  │
│  │ セッサ  │  │         │  │             │  │
│  └─────────┘  └─────────┘  └─────────────┘  │
└─────────────────────────────────────────────┘
          │            │            │
          ▼            ▼            ▼
┌─────────────────────────────────────────────┐
│             Kelpieフレームワーク            │
└─────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────┐
│                ScalarDB API                 │
└─────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────┐
│          データベース（バックエンド）         │
└─────────────────────────────────────────────┘
```

### コンポーネントの役割

1. **プリプロセッサ**: データロードや初期化処理を行う
   - TpccLoader: TPC-Cのテーブルにデータを投入
   - Loader: YCSBのデータを生成・投入
   - MultiStorageLoader: 複数ストレージ向けのデータを生成・投入

2. **プロセッサ**: 実際のベンチマーク処理を実行
   - TpccBench: TPC-Cワークロードの実行
   - WorkloadA/C/F: YCSBの各ワークロードの実行
   - MultiStorageWorkloadC/F: 複数ストレージのYCSBワークロード実行

3. **ポストプロセッサ**: 結果集計とレポート生成
   - TpccReporter: TPC-Cの実行結果を集計・レポート
   - YcsbReporter: YCSBの実行結果を集計・レポート

## 主要な設計パターン

### 1. モジュール型設計

ベンチマークは異なるワークロードモジュールに分けられています：
- TPC-C関連クラス群
- YCSB関連クラス群
- マルチストレージYCSB関連クラス群

各モジュールは独立して動作し、共通インターフェースや基底クラスを実装しています。

### 2. トランザクション設計パターン

特にTPC-Cの実装では、各トランザクションタイプがクラスとして表現されています：
- NewOrderTransaction
- PaymentTransaction
- OrderStatusTransaction
- DeliveryTransaction
- StockLevelTransaction

これらのトランザクションクラスは`TpccTransaction`インターフェースを実装し、一貫した操作方法を提供しています。

### 3. ファクトリーパターン

`TransactionFactory`クラスを使用してトランザクションマネージャのインスタンスを生成し、実装の詳細を隠蔽しています。

### 4. コンフィギュレーションパターン

TOMLファイルとJavaの設定クラスを使ってベンチマーク実行の設定を柔軟に行えるようになっています。

## コンポーネント間の関係

### データフロー

1. **設定読み込み**:
   - TOMLファイル → 各ベンチマークモジュール

2. **データ初期化**:
   - プリプロセッサ → ScalarDB API → データベース

3. **ベンチマーク実行**:
   - プロセッサ → ScalarDB API → データベース
   - プロセッサ → 測定結果 → ポストプロセッサ

### 依存関係

- 各ベンチマークモジュールは`Common`クラスに依存
- トランザクション実装クラスはScalarDBのAPIに依存
- テーブル定義クラスはデータモデルを表現

## 重要な実装パス

### TPC-Cワークフロー

1. `TpccLoader`: スキーマに基づきデータ生成
2. `TpccBench`: 各トランザクションタイプの分布に従い実行
3. トランザクションクラス: ビジネスロジック実行
4. `TpccReporter`: 結果集計とレポート生成

### YCSBワークフロー

1. `Loader`: レコード生成と投入
2. `WorkloadX`: 特定のワークロードパターンに従い操作実行
3. `YcsbReporter`: 結果集計とレポート生成

## エラー処理戦略

1. **トランザクション競合**:
   - 競合検出時に自動リトライ
   - バックオフ戦略でリトライ間隔を調整（設定可能）

2. **例外ハンドリング**:
   - トランザクション内での例外発生時は適切にロールバック
   - Kelpieフレームワークへエラー情報を伝搬

## スレッド管理

- 並行性（concurrency）パラメータで制御
- ワークロードごとに適切な並行実行数を設定可能
- 負荷テスト時にはこの値を調整して最大スループットを探索

## パフォーマンス最適化

- トランザクション実装の効率化
- 適切なインデックス利用（オプションで制御可能）
- バッチ処理のサポート（特にロード時）
- リトライロジックの最適化
