# ScalarDB ベンチマークツール: アクティブコンテキスト

## 現在の作業状況

ScalarDBベンチマークツールは、データベースのパフォーマンスを測定するために設計された一連のツールです。現在、プロジェクトには以下のベンチマークが実装されています：
- TPC-C ベンチマーク（完全実装）
- YCSB ベンチマーク（ワークロードA、C、F）
- マルチストレージYCSB ベンチマーク（ワークロードC、F）
- **ABACマルチユーザーYCSB ベンチマーク（ワークロードC）** ✅ 完全実装

**重要な変更**: 通常のマルチユーザーYCSBベンチマークは削除され、ABACマルチユーザーベンチマークに統合されました。ABACモードが複数ユーザーによる並列実行とスケーラビリティテストの両方をサポートします。

プロジェクトは本格的な運用段階にあり、各ベンチマークが独立したモジュールとして安定的に動作します。現在の主要な価値提供は、ScalarDBの性能評価における業界標準ベンチマークの実行と、**ABAC環境でのパフォーマンス評価機能とスケーラビリティ評価機能の統合**です。

## 最近の変更点

プロジェクトの公開リポジトリには、以下の機能が実装されています：
- ベンチマーク実行のための基本的なフレームワーク構造
- TPC-Cの完全な実装
- YCSBの3つのワークロードパターン（A、C、F）の実装
- マルチストレージ環境でのYCSBベンチマーク実行サポート
- 柔軟な設定オプション

最近追加・更新された機能：
- READMEの中央化されたScalarDBドキュメントリポジトリへの参照
- 適切なエラーハンドリングの実装
- パフォーマンス最適化の改善
- **マルチユーザーモードの実装**
  - 複数ScalarDBユーザーによる並列アクセスのベンチマーク
  - ユーザー作成と権限管理機能
  - ユーザーごとの固有キー範囲によるアクセス分散
- **ABACマルチユーザーモードの実装** ✅ 新規追加
  - 属性ベースアクセス制御環境でのベンチマーク
  - 権限チェック結果の詳細分析
  - デバッグ・トラブルシューティング機能

## 最新の更新

### 完了した項目（2025/5/27）
1. **ABAC用Insert機能の実装完了**
   - YcsbCommonにprepareInsertメソッドを追加
   - MultiUserAbacLoaderでABACが有効な場合にputの代わりにinsertを使用
   - テーブルを毎回削除するため、insertのみでデータロードが完了
   - ABACの制約に対応した安全なデータ挿入処理を実装

2. **MultiUserAbacLoaderの独立化完了**
   - MultiUserLoaderを継承せず、PreProcessorを直接継承する独立したクラスに変更
   - ABAC専用の実装として、常にinsertを使用
   - テーブル削除・再作成、ユーザー作成、ABAC環境セットアップを自己完結で実行
   - ABAC使用時のみ使用される専用ローダーとして最適化
   - MultiUserLoaderは元の状態を維持（変更をロールバック）

3. **ABACマルチユーザーベンチマークの本格実装完了**（2025/5/27確認）
   - MultiUserAbacLoader.setupAbacEnvironment()の完全実装
     - AbacAdmin APIを使用したポリシー作成・有効化
     - レベル/コンパートメント/グループ属性の作成
     - テーブルポリシーの適用と有効化
     - ユーザーへの属性割り当て
   - MultiUserAbacWorkloadC.simulateAbacCheck()の実装
   - Common.getAbacAdmin()メソッドの実装
   - ビルドテスト完了、コンパイルエラーなし

4. **デバッグ・トラブルシューティング機能の追加完了**（2025/5/27追加）
   - 数値不一致問題の調査と解決
   - 詳細メトリクスの追加（Transaction execution count, ExecuteEach call count）
   - YcsbReporterにDebug Informationセクションを追加
   - 初期化時の設定値ログ出力機能
   - Kelpieフレームワークの計測方法による正常な差異であることを確認

5. **ドキュメント整備完了**（2025/5/27）
   - tasks/abac-multi-user-benchmark-implementation-summary.md作成
   - tasks/abac-multi-user-benchmark-test-results.md作成
   - tasks/abac-multi-user-benchmark-tasks.md更新（完了状態反映）

## 次のステップ

### 短期的な改善点（緊急度：高）
1. **ABACマルチユーザーベンチマークの実地テストと検証** ✅ 完了
   - ✅ 本格実装は完了済み（AbacAdmin API使用）
   - ✅ 実際のScalarDB ABAC環境での動作確認完了
   - ✅ 属性ベースアクセス制御の権限チェック動作検証完了
   - ✅ パフォーマンスメトリクスの精度向上完了
2. マルチユーザーモード拡張（他のワークロードA、Fへの適用）
3. より詳細なパフォーマンスメトリクスの収集と分析機能
4. 他のYCSBワークロード（B、D、E）の実装検討
5. 異なるデータベースバックエンドでの検証とテストケース拡充
6. ユーザードキュメンテーションとベストプラクティスガイドの改善

### 中長期的な改善点（継続的な価値向上）
1. より新しいJDKバージョンのサポート（JDK 11, 17）
2. カスタムワークロードの定義機能の追加
3. グラフィカルな結果レポート機能とダッシュボード
4. 継続的インテグレーション環境での自動ベンチマーク実行
5. クラウドネイティブな実行環境への対応
6. **LoadBalanced戦略の実装**（ABAC属性割り当て戦略の拡張）

## アクティブな意思決定と考慮事項

### パフォーマンス測定の正確性
- トランザクション実行時間の測定方法の標準化
- リトライによる影響を考慮したレポーティング
- ウォームアップ期間（ramp_for_sec）の適切な設定の推奨
- **Kelpieフレームワークの計測方法の理解**（実行時間境界での差異は正常）

### ワークロードの設計
- 実際のアプリケーションパターンを反映したワークロード構成
- 複数のストレージを使用するアプリケーションのテスト方法
- **マルチユーザー環境におけるパフォーマンス特性の評価**
- **ユーザー数とキー範囲分割方法の最適化**
- **ABAC環境でのパフォーマンス影響の評価**

### 技術的な負債
- JDK 8依存による将来的な互換性の課題
- エラー処理とリトライロジックの改善余地
- テスト網羅率の向上

## 学びとプロジェクトの洞察

### ベンチマーク設計の知見
- データベースのパフォーマンス特性は、ワークロードパターンによって大きく異なる
- トランザクションの分離レベルとスループットのトレードオフの重要性
- 適切なインデックス戦略がパフォーマンスに与える影響
- **ユーザー数増加に対するスケーラビリティの分析手法**
- **ABAC権限チェックによるパフォーマンス影響の測定手法**

### ScalarDB固有の特性
- マルチストレージ環境でのトランザクション処理の複雑さ
- 競合解決メカニズムとバックオフ戦略の効果
- 様々なバックエンドデータベースでの挙動の違い
- **複数ユーザーによる並列アクセス時の認証・権限管理の影響**
- **ABAC環境でのREAD操作の権限チェック動作**

### ユーザーフィードバック
- より簡単なセットアッププロセスへの要望
- クラウド環境での実行に関するガイダンスの必要性
- 標準的なベンチマーク結果の参照データへのアクセス
- **マルチユーザー環境でのパフォーマンス影響の評価ニーズ**
- **ABAC環境でのパフォーマンス評価ニーズ**

## 重要なパターンと設定

### 推奨設定
- **適切なワークロード選択：**
  - トランザクション処理の評価にはTPC-C
  - 基本的なCRUD操作のスケーラビリティ評価にはYCSB
  - マルチユーザー環境の評価にはマルチユーザーYCSB
  - 複数ストレージ環境の評価にはマルチストレージYCSB
  - **ABAC環境の評価にはABACマルチユーザーYCSB**
- **パフォーマンステスト時の推奨パラメータ：**
  - 十分な`run_for_sec`（最低300秒、本格評価は600秒以上）
  - 適切な`ramp_for_sec`でJVMウォームアップを確保（最低60秒）
  - 環境に応じた`concurrency`と`user_count`の調整
  - リソース監視との組み合わせ（CPU、メモリ、ディスクI/O）
- **設定ファイルの管理：**
  - 環境ごとの設定ファイルのバージョン管理
  - 適切な接続プール設定とタイムアウト値
  - **ABAC属性設定の管理**

### トラブルシューティングパターン
- トランザクション競合率が高い場合の`backoff`値の調整
- メモリ不足エラーが発生した場合のJVMヒープサイズの増加
- データロード時の`load_concurrency`とバッチサイズの調整
- **マルチユーザーモード使用時のユーザー作成エラーの確認**
- **ABAC環境での権限設定エラーの確認**
- **数値不一致問題の調査手法**（デバッグメトリクスの活用）

### ベンチマーク実行戦略
1. 小規模な設定での初期テスト実行
2. システムリソースのモニタリング
3. ボトルネックの特定（CPU、メモリ、ネットワーク、ディスクI/O）
4. パラメータ調整と再テスト
5. スケールを拡大した本番的なテスト実行
6. **ユーザー数を変化させた比較テストの実施**
7. **ABAC有効/無効での比較テストの実施**
